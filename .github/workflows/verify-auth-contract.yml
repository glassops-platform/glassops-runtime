name: Auth Contract Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  verify-identity-contract:
    name: Verify Identity & Output Contract
    runs-on: ubuntu-latest
    if: github.repository_owner == 'glassops-platform'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize GlassOps Runtimeâ„¢
        id: runtime
        uses: ./
        with:
          jwt_key: ${{ secrets.SF_JWT_KEY }}
          client_id: ${{ secrets.SF_CLIENT_ID }}
          username: ${{ vars.SF_USERNAME }}
          enforce_policy: "false"

      - name: Validate Contract Primitives
        run: |
          echo "ðŸ” Verifying Identity Contract..."
          ORG_ID="${{ steps.runtime.outputs.org_id }}"
          if [[ ! "$ORG_ID" =~ ^00D ]]; then
            echo "âŒ Error: Invalid or missing org_id ($ORG_ID)"
            exit 1
          fi

          READY="${{ steps.runtime.outputs.glassops_ready }}"
          if [ "$READY" != "true" ]; then
            echo "âŒ Error: glassops_ready signal not emitted"
            exit 1
          fi

          echo "âœ… Identity Contract Verified: $ORG_ID"

          # Add Step Summary
          echo "## ðŸ” Auth Contract Verification" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Org ID** | \`$ORG_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Signal** | \`glassops_ready=true\` |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Verification Passed**" >> $GITHUB_STEP_SUMMARY

      - name: Audit Environment Setup
        run: |
          echo "ðŸ”§ Verifying CLI Environment..."
          sf org display --json | jq -e '.result.id' > /dev/null
          echo "âœ… CLI is authenticated and functional"
